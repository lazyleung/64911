  ; Unit test for DoorControll
  ; Ting Xu

  #INCLUDE defines.mf ;include CAN id and period definitions

  ;intialize
  0s I DOOR_OPENED_SENSOR_PERIOD    N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID     DoorOpened FRONT LEFT = false
  0s I DOOR_CLOSED_SENSOR_PERIOD    N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID   DoorClosed FRONT LEFT = true
  0s I DOOR_REVERSAL_NETWORK_PERIOD N DOOR_REVERSAL_SENSOR_[FRONT][LEFT]_CAN_ID DoorReversal FRONT LEFT = false
  0s I AT_FLOOR_PERIOD              N AT_FLOOR_[1][FRONT]_CAN_ID                AtFloor 1 FRONT = false
  0s I DISPATCHER_PERIOD            N DESIRED_FLOOR_CAN_ID                      DesiredFloor = 1 FRONT UP
  0s I DISPATCHER_PERIOD            N DESIRED_DWELL_[FRONT]_CAN_ID              Integer = 2
  0s I WEIGHT_PERIOD                N CAR_WEIGHT_CAN_ID                         CarWeight = 0
  0.0s I DRIVE_CONTROL_PERIOD         N DRIVE_SPEED_CAN_ID                        DriveSpeed = 0 STOP

  ;state 'S5.4 CLOSED'
  1.0s A F DoorMotor FRONT LEFT : command  == STOP

  ;transition 'T5.5'
  1.1s I AT_FLOOR_PERIOD              N AT_FLOOR_[1][FRONT]_CAN_ID                AtFloor 1 FRONT = true

  ;state 'S5.1 OPENING'
  2.0s A F DoorMotor FRONT LEFT : command  == OPEN

  ;transition 'T5.1'
  2.1s I DOOR_OPENED_SENSOR_PERIOD    N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID     DoorOpened FRONT LEFT = true
  2.1s I DOOR_CLOSED_SENSOR_PERIOD    N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID   DoorClosed FRONT LEFT = false
  2.1s I DISPATCHER_PERIOD            N DESIRED_FLOOR_CAN_ID                      DesiredFloor = 2 FRONT UP

  ;state 'S5.2 OPEN'
  3.0s A F DoorMotor FRONT LEFT : command  == STOP

  ;transition 'T5.2'
  ;countdown > 0  
  ;check that doors did not close too early
  4.0s A F DoorMotor FRONT LEFT : command  == STOP
  
  ;state 'S5.3 CLOSING'
  ;countdown <= 0  
  9.5s A F DoorMotor FRONT LEFT : command  == CLOSE
 
  ;transition 'T5.3'
  10s I DOOR_OPENED_SENSOR_PERIOD    N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID     DoorOpened FRONT LEFT = false
  10s I DOOR_CLOSED_SENSOR_PERIOD    N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID   DoorClosed FRONT LEFT = true
 
  ;state 'S5.4 CLOSED'
  11.5s A F DoorMotor FRONT LEFT : command  == STOP

  ;transition 'T5.5'
  12.0s I DISPATCHER_PERIOD            N DESIRED_FLOOR_CAN_ID                      DesiredFloor = 1 FRONT UP

  ;state 'S5.1 OPENING'
  13.0s A F DoorMotor FRONT LEFT : command  == OPEN

  ;transition 'T5.1'
  13.5s I DOOR_OPENED_SENSOR_PERIOD    N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID     DoorOpened FRONT LEFT = true
  13.5s I DOOR_CLOSED_SENSOR_PERIOD    N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID   DoorClosed FRONT LEFT = false

  ;state 'S5.2 OPEN'
  14.0s A F DoorMotor FRONT LEFT : command  == STOP

  ;transition 'T5.2'
  ;countdown <= 0  
  ;check that doors did not close too early
  15.5s A F DoorMotor FRONT LEFT : command  == STOP

  16.0s I DISPATCHER_PERIOD      N DESIRED_FLOOR_CAN_ID       DesiredFloor = 3 FRONT UP
    
  ;state 'S5.3 CLOSING'
  21.5s A F DoorMotor FRONT LEFT : command  == CLOSE

  ;transition 'T5.4'
  22s I DOOR_OPENED_SENSOR_PERIOD    N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID     DoorOpened FRONT LEFT = false
  22s I DOOR_CLOSED_SENSOR_PERIOD    N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID   DoorClosed FRONT LEFT = false
  22s I DOOR_REVERSAL_NETWORK_PERIOD N DOOR_REVERSAL_SENSOR_[FRONT][LEFT]_CAN_ID DoorReversal FRONT LEFT = true

  ;state 'S5.1 OPENING'
  23.0s A F DoorMotor FRONT LEFT : command  == OPEN
    
 ;transition 'T5.1'
  23.5s I DOOR_OPENED_SENSOR_PERIOD    N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID     DoorOpened FRONT LEFT = true
  23.5s I DOOR_CLOSED_SENSOR_PERIOD    N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID   DoorClosed FRONT LEFT = false

  ;state 'S5.2 OPEN'
  24.0s A F DoorMotor FRONT LEFT : command  == STOP

  ;transition 'T5.6'
  25.0s A F DoorMotor FRONT LEFT : command  == STOP
    
  ;state 'S5.5 NUDGE'
  37.5s A F DoorMotor FRONT LEFT : command  == NUDGE

  38s I DISPATCHER_PERIOD            N DESIRED_FLOOR_CAN_ID                      DesiredFloor = 2 FRONT UP


  ;transition 'T5.7'
  39s I DOOR_OPENED_SENSOR_PERIOD    N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID     DoorOpened FRONT LEFT = false
  39s I DOOR_CLOSED_SENSOR_PERIOD    N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID   DoorClosed FRONT LEFT = true
 
  ;state 'S5.4 CLOSED'
  40.5s A F DoorMotor FRONT LEFT : command  == STOP
